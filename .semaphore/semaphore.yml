version: v1.0
name: Initial Pipeline

agent:
  machine:
    type: e1-standard-2

blocks:
- name: Install CMake
  task:
    jobs:
    - name: Compile and Test
      env_vars:
      - name: CMAKE_VERSION
        value: "3.16.4"
      - name: CTEST_PARALLEL_LEVEL
        value: "4"
      commands:
      - cache restore "cmake-tarball-$CMAKE_VERSION"
      - wget -N "https://github.com/Kitware/CMake/releases/download/v$CMAKE_VERSION/cmake-$CMAKE_VERSION-Linux-x86_64.tar.gz"
      - cache store "cmake-tarball-$CMAKE_VERSION" "cmake-$CMAKE_VERSION-Linux-x86_64.tar.gz"
      - sudo tar -C /usr/local -xzf "cmake-$CMAKE_VERSION-Linux-x86_64.tar.gz" --strip-components=1
      - sem-version c 5
      - checkout
      - cmake .
      - ctest --output-on-failure
      matrix:
      - env_var: CC
        values: ["gcc-5"]
