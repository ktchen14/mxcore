version: v1.0
name: Initial Pipeline

agent:
  machine:
    type: e1-standard-2
  containers:
  - name: main
    image: ktchen14/vector-ci-debian

blocks:

- name: Update Docker Image
  task:
    agent: { machine: { type: e1-standard-2 } }
    env_vars:
    - name: DOCKER_NAME
      value: ktchen14/vector-ci-debian
    prologue:
      commands:
      - docker login -u "$DOCKER_USERNAME" --password-stdin <<< "$DOCKER_PASSWORD"
    epilogue:
      always:
        commands:
        - docker logout
    jobs:
    - name: Build and Push Docker Image
      commands:
      - checkout
      - docker build ci -f ci/Dockerfile.debian -t "$DOCKER_NAME"
      - docker push "$DOCKER_NAME"
    secrets:
    - name: Vector CI Docker Authentication
  run:
    when: change_in('ci/Dockerfile.debian')

- name: Compile and Test
  task:
    env_vars:
    - name: CTEST_PARALLEL_LEVEL
      value: 4
    jobs:
    - name: Compile and Test
      commands:
      - checkout
      - cmake .
      - ctest --output-on-failure
